/* ==========================================================================
 *                            ‰ª•‰∏ã‰∏∫Êï∞ÊçÆÁªìÊûÑ
 * ==========================================================================
 *
 *
 * ==========================================================================
 * rootdir
 * --------------------------------------------------------------------------
 * '/path/to/Adachi-BOT'
 * ==========================================================================
 *
 * ==========================================================================
 * configdir
 * --------------------------------------------------------------------------
 * '/path/to/Adachi-BOT/config'
 * ==========================================================================
 *
 * ==========================================================================
 * configdefdir
 * --------------------------------------------------------------------------
 * '/path/to/Adachi-BOT/config_defaults'
 * ==========================================================================
 *
 * ==========================================================================
 * datadir
 * --------------------------------------------------------------------------
 * '/path/to/Adachi-BOT/data'
 * ==========================================================================
 *
 * ==========================================================================
 * oicqdir
 * --------------------------------------------------------------------------
 * '/path/to/Adachi-BOT/data'
 * ==========================================================================
 *
 * ==========================================================================
 * resdir
 * --------------------------------------------------------------------------
 * '/path/to/Adachi-BOT/resources'
 * ==========================================================================
 *
 * ==========================================================================
 * package
 * --------------------------------------------------------------------------
 * context of this project's package.json
 * ==========================================================================
 *
 * ==========================================================================
 * global.all
 * --------------------------------------------------------------------------
 * {
 *   functions: {
 *     entrance: { hello_world: [ '^hello' ], eat: [ '^eat' ] },
 *     options: { eat: { apple: 'ËãπÊûú', banana: 'È¶ôËïâ', egg: 'Ëõã' } }
 *   },
 *   function: { hello_world: [ 'hello_world' ], eat: [ 'eat' ] }
 * }
 * --------------------------------------------------------------------------
 * global.command and global.master
 * --------------------------------------------------------------------------
 * {
 *   functions: {
 *     type: { hello_world: 'command', eat: 'option' },
 *     show: { hello_world: true, eat: true },
 *     weights: { hello_world: 9999, eat: 9999 },
 *     name: { hello_world: 'hello world', eat: 'eat' },
 *     usage: { hello_world: undefined, eat: undefined },
 *     revert: { hello_world: false, eat: false },
 *     description: { hello_world: 'I will say hello to you', eat: 'What to eat' },
 *     entrance: { hello_world: [ '^hello' ], eat: [ '^eat' ] },
 *     options: { eat: { apple: 'ËãπÊûú', banana: 'È¶ôËïâ', egg: 'Ëõã' } }
 *   },
 *   enable: { hello_world: true, eat: true },
 *   weights: { hello_world: 9999, eat: 9989 },
 *   regex: {
 *     '^hello\\sworld(!)?\\s*$': [ 'hello_world' ],
 *     '^eat\\s*\\S+\\s*$': [ 'eat' ]
 *   },
 *   function: { hello_world: [ 'hello_world' ], eat: [ 'eat' ] },
 *   usage: 'üîò hello world üëâ I will say hello to you\n' +
 *     'üîò eat <ËãπÊûú„ÄÅÈ¶ôËïâ„ÄÅËõã> üëâ What to eat\n' +
 *     '-------------------\n' +
 *     '<> Ë°®Á§∫ÂøÖÂ°´Ôºå[] Ë°®Á§∫ÂèØÈÄâ'
 * }
 * --------------------------------------------------------------------------
 * ../../config/command*.yml
 * --------------------------------------------------------------------------
 * Hello_World:
 *   enable: true
 *   weights: 9999
 *   regex:
 *     - ^hello\sworld(!)?\s*$
 *   functions:
 *     Hello_World:
 *       type: command
 *       show: true
 *       weights: 9999
 *       name: hello world
 *       usage:
 *       revert: false
 *       description: I will say hello to you
 *       entrance:
 *         - ^hello
 * Eat:
 *   enable: true
 *   weights: 9989
 *   regex:
 *     - ^eat\s*\S+\s*$
 *   functions:
 *     eat:
 *       type: option
 *       show: true
 *       weights: 9999
 *       name: eat
 *       usage:
 *       revert: false
 *       description: What to eat
 *       entrance:
 *         - ^eat
 *       options:
 *         Apple: ËãπÊûú
 *         Banana: È¶ôËïâ
 *         Egg: Ëõã
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.authority
 * --------------------------------------------------------------------------
 * {
 *   setting: {
 *     artifact_auth: [ 'artifacts', 'strengthen', 'dungeons' ],
 *     character_overview_auth: [ 'info', 'material', 'weapon', 'talent', 'weekly' ],
 *     feedback_auth: [ 'feedback' ],
 *     fun_auth: [ 'menu', 'prophecy', 'roll' ],
 *     gacha_auth: [ 'gacha', 'pool', 'select', 'select-nothing', 'select-what' ],
 *     music_auth: [ 'music', 'music_source' ],
 *     mys_news_auth: [ 'Á±≥Ê∏∏Á§æÊñ∞ÈóªÊé®ÈÄÅ' ],
 *     query_gameinfo_auth: [
 *       'save',
 *       'change',
 *       'aby',
 *       'lastaby',
 *       'card',
 *       'package',
 *       'character',
 *       'others_character'
 *     ],
 *     rating_auth: [ 'rating' ],
 *     reply_auth: [ 'ÂìçÂ∫îÊ∂àÊÅØ' ]
 *   },
 *   default: {
 *     artifact_auth: true,
 *     character_overview_auth: true,
 *     feedback_auth: true,
 *     fun_auth: true,
 *     gacha_auth: true,
 *     music_auth: true,
 *     rating_auth: true,
 *     mys_news_auth: true,
 *     reply_auth: true
 *   },
 *   function: {
 *     artifacts: 'artifact_auth',
 *     strengthen: 'artifact_auth',
 *     dungeons: 'artifact_auth',
 *     info: 'character_overview_auth',
 *     material: 'character_overview_auth',
 *     weapon: 'character_overview_auth',
 *     talent: 'character_overview_auth',
 *     weekly: 'character_overview_auth',
 *     feedback: 'feedback_auth',
 *     menu: 'fun_auth',
 *     prophecy: 'fun_auth',
 *     roll: 'fun_auth',
 *     gacha: 'gacha_auth',
 *     pool: 'gacha_auth',
 *     select: 'gacha_auth',
 *     'select-nothing': 'gacha_auth',
 *     'select-what': 'gacha_auth',
 *     music: 'music_auth',
 *     music_source: 'music_auth',
 *     'Á±≥Ê∏∏Á§æÊñ∞ÈóªÊé®ÈÄÅ': 'mys_news_auth',
 *     save: 'query_gameinfo_auth',
 *     change: 'query_gameinfo_auth',
 *     aby: 'query_gameinfo_auth',
 *     lastaby: 'query_gameinfo_auth',
 *     card: 'query_gameinfo_auth',
 *     package: 'query_gameinfo_auth',
 *     character: 'query_gameinfo_auth',
 *     others_character: 'query_gameinfo_auth',
 *     rating: 'rating_auth',
 *     'ÂìçÂ∫îÊ∂àÊÅØ': 'reply_auth'
 *   }
 * }
 * --------------------------------------------------------------------------
 * ../../config/authority.yml
 * --------------------------------------------------------------------------
 * default:
 *   artifact_auth: on
 *   character_overview_auth: on
 *   feedback_auth: on
 *   fun_auth: on
 *   gacha_auth: on
 *   music_auth: on
 *   rating_auth: on
 *   mys_news_auth: on
 *   reply_auth: on
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.config
 * --------------------------------------------------------------------------
 * {
 *   accounts: [ { qq: 123456789, password: 'zhimakaimen', platform: 5 } ],
 *   masters: [ 987654321 ],
 *   prefixes: [ null ],
 *   atMe: 1,
 *   atUser: 1,
 *   checkMasterAuth: 0,
 *   replyStranger: 1,
 *   repeatProb: 1,
 *   groupHello: 1,
 *   groupGreetingNew: 1,
 *   friendGreetingNew: 1,
 *   noticeMysNews: 1,
 *   noticeMysNewsWithinHours: 24,
 *   mysNewsType: [],
 *   characterTryGetDetail: 1,
 *   requestInterval: 0,
 *   deleteGroupMsgTime: 0,
 *   boardcastDelay : 0.2,
 *   cacheAbyEffectTime: 1,
 *   cacheInfoEffectTime: 1,
 *   dbAbyEffectTime: 1,
 *   dbInfoEffectTime: 168,
 *   viewDebug: 0
 * }
 * --------------------------------------------------------------------------
 * ../../config/setting.yml
 * --------------------------------------------------------------------------
 * accounts:
 *   -
 *     qq: 123456789
 *     password: zhimakaimen
 *     platform: 5
 * masters:
 *   - 987654321
 * atMe: 1
 * atUser: 1
 * checkMasterAuth: 0,
 * replyStranger: 1
 * repeatProb: 1
 * groupHello: 1
 * groupGreetingNew: 1
 * friendGreetingNew: 1
 * noticeMysNews: 1
 * noticeMysNewsWithinHours: 24,
 * mysNewsType: []
 * characterTryGetDetail: 1
 * requestInterval: 0
 * deleteGroupMsgTime: 0
 * boardcastDelay: 0.2
 * prefixes:
 *   -
 * cacheAbyEffectTime: 1
 * cacheInfoEffectTime: 1
 * dbAbyEffectTime: 1
 * dbInfoEffectTime: 168
 * viewDebug: 0
  ==========================================================================
 *
 *
  ==========================================================================
 * global.cookies
 * --------------------------------------------------------------------------
 * [
 *   'UM_distinctid=...; _ga=...; _gid=...; CNZZDATA1275023096=...; _MHYUUID=...; ltoken=...; ltuid=...; cookie_token=...; account_id=...'
 * ]
 * --------------------------------------------------------------------------
 * ../../config/cookies.yml
 * --------------------------------------------------------------------------
 * cookies:
 *   - UM_distinctid=...; _ga=...; _gid=...; CNZZDATA1275023096=...; _MHYUUID=...; ltoken=...; ltuid=...; cookie_token=...; account_id=...
  ==========================================================================
 *
 *
  ==========================================================================
 * global.greeting
 * --------------------------------------------------------------------------
 * { online: '‰∏äÁ∫ø‰∫Ü„ÄÇ', die: '‰∏äÁ∫ø‰∫ÜÔºå‰ΩÜÂèàÊ≤°‰∏ä„ÄÇ', hello: 'Â§ßÂÆ∂Â•Ω„ÄÇ', new: 'Âêë‰Ω†ÈóÆÂ•Ω„ÄÇ' }
 * --------------------------------------------------------------------------
 * ../../config/greeting.yml
 * --------------------------------------------------------------------------
 * online: ‰∏äÁ∫ø‰∫Ü„ÄÇ
 * die: ‰∏äÁ∫ø‰∫ÜÔºå‰ΩÜÂèàÊ≤°‰∏ä„ÄÇ
 * hello: Â§ßÂÆ∂Â•Ω„ÄÇ
 * new: Âêë‰Ω†ÈóÆÂ•Ω„ÄÇ
  ==========================================================================
 *
 *
 * ==========================================================================
 * global.menu
 * --------------------------------------------------------------------------
 * {
 *   eat: {
 *     breakfast: [ 'Â∫ÑÂõ≠ÁÉ§ÊùæÈ•º' ],
 *     lunch: [ 'ËúúÈÖ±ËÉ°ËêùÂçúÁÖéËÇâ' ],
 *     dinner: [ 'ÁîúÁîúËä±ÈÖøÈ∏°' ],
 *     snack: [ 'ËìùËéìÂ±±ËçØ' ]
 *   },
 *   drink: { base: [ 'ÁáïÈ∫¶Â•∂Ëå∂' ], topping: [ 'ËäãÊ≥•' ], sweetness: [ 'Êó†Á≥ñ' ] }
 * }
 * --------------------------------------------------------------------------
 * ../../config/menu.yml
 * --------------------------------------------------------------------------
 * eat:
 *   breakfast:
 *     - Â∫ÑÂõ≠ÁÉ§ÊùæÈ•º
 *   lunch:
 *     - ËúúÈÖ±ËÉ°ËêùÂçúÁÖéËÇâ
 *   dinner:
 *     - ÁîúÁîúËä±ÈÖøÈ∏°
 *   snack:
 *     - ËìùËéìÂ±±ËçØ
 * drink:
 *   base:
 *     - ÁáïÈ∫¶Â•∂Ëå∂
 *   topping:
 *     - ËäãÊ≥•
 *   sweetness:
 *     - Êó†Á≥ñ
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.prophecy
 * --------------------------------------------------------------------------
 * {
 *   data: [
 *     {
 *       summary: 'Â§ßÂêâ',
 *       lucky: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ',
 *       text: '‰ªäÊó•Â§ßÂêâ',
 *       annotation: '‰ªäÂ§©‰Ω†ÂæàÂπ∏Ëøê'
 *     }
 *   ]
 * }
 * --------------------------------------------------------------------------
 * ../../config/prophecy.yml
 * --------------------------------------------------------------------------
 * data:
 *   -
 *     summary: Â§ßÂêâ
 *     lucky: "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ"
 *     text: ‰ªäÊó•Â§ßÂêâ
 *     annotation: ‰ªäÂ§©‰Ω†ÂæàÂπ∏Ëøê
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.names
 * --------------------------------------------------------------------------
 * {
 *   characterAlias: { 'Áå´': 'Ëø™Â••Â®ú', dio: 'Ëø™Â••Â®ú', 'Ëø™Â••Â®ú': 'Ëø™Â••Â®ú' },
 *   weaponAlias: { 'Êü¥ÁÅ´Ê£ç': 'Êä§Êë©‰πãÊùñ', homo: 'Êä§Êë©‰πãÊùñ', 'Êä§Êë©‰πãÊùñ': 'Êä§Êë©‰πãÊùñ' },
 *   allAlias: {
 *     'Áå´': 'Ëø™Â••Â®ú',
 *     dio: 'Ëø™Â••Â®ú',
 *     'Ëø™Â••Â®ú': 'Ëø™Â••Â®ú',
 *     'Êü¥ÁÅ´Ê£ç': 'Êä§Êë©‰πãÊùñ',
 *     homo: 'Êä§Êë©‰πãÊùñ',
 *     'Êä§Êë©‰πãÊùñ': 'Êä§Êë©‰πãÊùñ'
 *   },
 *   character: [ 'Áå´', 'Ëø™Â••Â®ú', 'dio' ],
 *   weapon: [ 'Êü¥ÁÅ´Ê£ç', 'Êä§Êë©‰πãÊùñ', 'homo' ],
 *   all: [ 'Áå´', 'Ëø™Â••Â®ú', 'dio', 'Êü¥ÁÅ´Ê£ç', 'Êä§Êë©‰πãÊùñ', 'homo' ]
 * }
 * --------------------------------------------------------------------------
 * ../../config/names.yml
 * --------------------------------------------------------------------------
 * character:
 *   Ëø™Â••Â®ú: [ Áå´, dio ]
 * weapon:
 *   Êä§Êë©‰πãÊùñ: [ Êü¥ÁÅ´Ê£ç, homo ]
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.artifacts
 * --------------------------------------------------------------------------
 * {
 *   weights: [ [] ],
 *   values: [ [] ],
 *   props: [ {} ],
 *   path: [ 4, 2, 5, 1, 3 ],
 *   artifacts: {
 *     id: { 'ÊÇ†Âè§ÁöÑÁ£êÂ≤©': 0 },
 *     rarity: { '0': 5 },
 *     icon: { '23499': 0 },
 *     suit: { '0': 'ÊÇ†Âè§ÁöÑÁ£êÂ≤©' },
 *     names: { '0': [ 'ÁõòÈôÄË£ÇÁîü‰πãËä±', 'ÂµØÂ≥®Áæ§Â≥∞‰πãÁøº', 'ÊòüÁΩóÂú≠Â£Å‰πãÊô∑', 'Â∑âÂ≤©Áê¢Â°ë‰πãÊ®Ω', '‰∏çÂä®ÁéÑÁü≥‰πãÁõ∏' ] }
 *   },
 *   domains: {
 *     id: { '‰∏ñÁïåbossÊåëÊàò': 0 },
 *     name: { '0': '‰∏ñÁïåbossÊåëÊàò' },
 *     alias: { boss: '‰∏ñÁïåbossÊåëÊàò' },
 *     aliasOf: { '0': [ 'boss' ] },
 *     product: { '0': [ 4, 13 ] }
 *   }
 * }
 * --------------------------------------------------------------------------
 * ../../config/artifacts.yml
 * --------------------------------------------------------------------------
 * weights:
 *   - [ ]
 * values:
 *   - [ ]
 * props:
 *   - { }
 * path: [ 4, 2, 5, 1, 3 ]
 * artifacts:
 *   - id: 0
 *     rarity: 5
 *     icon: 23499
 *     suit: ÊÇ†Âè§ÁöÑÁ£êÂ≤©
 *     names: [ ÁõòÈôÄË£ÇÁîü‰πãËä±, ÂµØÂ≥®Áæ§Â≥∞‰πãÁøº, ÊòüÁΩóÂú≠Â£Å‰πãÊô∑, Â∑âÂ≤©Áê¢Â°ë‰πãÊ®Ω, ‰∏çÂä®ÁéÑÁü≥‰πãÁõ∏ ]
 * domains:
 *   - id: 0
 *     name: ‰∏ñÁïåBOSSÊåëÊàò
 *     alias: [ boss ]
 *     product: [ 4, 13 ]
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.eggs
 * --------------------------------------------------------------------------
 * { type: { 'ÂàªÊô¥': 'ËßíËâ≤', 'Â§©Á©∫‰πãÂàÉ': 'Ê≠¶Âô®' }, star: { 'ÂàªÊô¥': 5, 'Â§©Á©∫‰πãÂàÉ': 5 } }
 * --------------------------------------------------------------------------
 * ../../config/pool_eggs.yml
 * --------------------------------------------------------------------------
 * items:
 *   -
 *     type: ËßíËâ≤
 *     star: 5
 *     names:
 *       - ÂàªÊô¥
 *   -
 *     type: Ê≠¶Âô®
 *     star: 5
 *     names:
 *       - Â§©Á©∫‰πãÂàÉ
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.qa
 * --------------------------------------------------------------------------
 * { 'ÈóÆÈ¢òÔºü': { ignoreCase: false, type: 'text', reply: 'Á≠îÊ°àÔºÅ' } }
 * --------------------------------------------------------------------------
 * ../../config/qa.yml
 * --------------------------------------------------------------------------
 * settings:
 *   -
 *     match:
 *       - ÈóÆÈ¢òÔºü
 *     ignoreCase: false
 *     type: text
 *     reply: Á≠îÊ°àÔºÅ
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.info.material
 * --------------------------------------------------------------------------
 * { MonThu: [ 'ÂàªÊô¥', 'È£éÈπ∞Ââë' ] }
 * --------------------------------------------------------------------------
 * global.info.character
 * global.info.weapon
 * --------------------------------------------------------------------------
 * Êï∞ÊçÆÁªìÊûÑËßÅÂÖ∂ÂêéËØ¥Êòé„ÄÇ
 * ==========================================================================
 *
 *
 * ==========================================================================
 * global.info.character
 * global.info.weapon
 * --------------------------------------------------------------------------
 * Êï∞ÁªÑ‰∏≠ÂÖÉÁ¥†ÁöÑÊï∞ÊçÆÁªìÊûÑ‰∏éÂéüÊñá‰ª∂‰∏ÄËá¥Ôºå‰ª•Â≠óÊÆµ rarity ÈôçÂ∫è„ÄÇ
 * --------------------------------------------------------------------------
 * ../../resources/info/doc/<ËßíËâ≤Âêç>.json
 * ../../resources/info/doc/<Ê≠¶Âô®Âêç>.json
 * --------------------------------------------------------------------------
 * ËØ∑Áõ¥Êé•Êü•ÁúãÊñá‰ª∂ÂÜÖÂÆπ„ÄÇ
 * ==========================================================================
 *
 *
 * ==========================================================================
 *                            ‰ª•‰∏ä‰∏∫Êï∞ÊçÆÁªìÊûÑ
 * ========================================================================== */
import fs from "fs";
import lodash from "lodash";
import path from "path";
import url from "url";
import { ls } from "#utils/file";
import { loadYML } from "#utils/yaml";

("use strict");

const __filename = url.fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

global.rootdir = Object.freeze(path.resolve(__dirname, "..", ".."));

global.configdefdir = Object.freeze(path.resolve(global.rootdir, "config_defaults"));
global.configdir = Object.freeze(path.resolve(global.rootdir, "config"));
global.datadir = Object.freeze(path.resolve(global.rootdir, "data"));
global.oicqdir = global.datadir;
global.resdir = Object.freeze(path.resolve(global.rootdir, "resources"));

global.innerAuthName = Object.freeze({ reply: "ÂìçÂ∫îÊ∂àÊÅØ", mysNews: "Á±≥Ê∏∏Á§æÊñ∞ÈóªÊé®ÈÄÅ", qa: "ÈóÆÁ≠îÊùÉÈôê" });

global.all = {};
global.artifacts = {};
global.authority = {
  setting: {
    artifact_auth: ["artifacts", "strengthen", "dungeons"],
    character_overview_auth: ["info", "material", "weapon", "talent", "weekly"],
    feedback_auth: ["feedback"],
    fun_auth: ["menu", "prophecy", "roll"],
    gacha_auth: ["gacha", "pool", "select", "select-nothing", "select-what"],
    music_auth: ["music", "music_source"],
    mys_news_auth: [global.innerAuthName.mysNews],
    qa_auth: [global.innerAuthName.qa],
    query_gameinfo_auth: ["save", "aby", "lastaby", "card", "package", "character", "others_character"],
    rating_auth: ["rating"],
    reply_auth: [global.innerAuthName.reply],
  },
};
global.command = {};
global.config = { mysNewsTypeAll: ["announcement", "event", "information"] };
global.cookies = [];
global.eggs = {};
global.greeting = {};
global.info = {};
global.master = {};
global.menu = {};
global.names = {};
global.package = Object.freeze(JSON.parse(fs.readFileSync(path.resolve(global.rootdir, "package.json"))));
global.prophecy = {};
global.qa = {};

const m_QA = Object.freeze(loadYML("qa"));
const m_ARTIFACTS = Object.freeze(loadYML("artifacts"));
const m_AUTHORITY = Object.freeze(loadYML("authority"));
const m_COMMAND = Object.freeze(loadYML("command"));
const m_COOKIES = Object.freeze(loadYML("cookies"));
const m_EGGS = Object.freeze(loadYML("pool_eggs"));
const m_GREETING = Object.freeze(loadYML("greeting"));
const m_MASTER = Object.freeze(loadYML("command_master"));
const m_MENU = Object.freeze(loadYML("menu"));
const m_NAMES = Object.freeze(loadYML("names"));
const m_PROPHECY = Object.freeze(loadYML("prophecy"));
const m_SETTING = Object.freeze(loadYML("setting"));

// global[type].enable                -> plugin (lowercase):    is_enabled (boolean)
// global[type].weights               -> plugin (lowercase):    weights (number)
// global[type].regex                 -> regex (lowercase):     plugin (string)
// global[type].function              -> function (lowercase):  plugin (array of string, lowercase)
// global[type].functions.type        -> function (lowercase):  type (string)
// global[type].functions.show        -> function (lowercase):  is_show (boolean)
// global[type].functions.weights     -> function (lowercase):  weights (number)
// global[type].functions.name        -> function (lowercase):  name (string)
// global[type].functions.usage       -> function (lowercase):  usage (string)
// global[type].functions.revert      -> function (lowercase):  revert (boolean)
// global[type].functions.description -> function (lowercase):  description (string)
// global[type].functions.entrance    -> function (lowercase):  entrance (array of string, lowercase)
// global[type].functions.options     -> function (lowercase):  { function: { option: text } } (both lowercase)
function getCommand(obj, type) {
  function reduce(obj, key, lowercase = [false, false], defaultValue = undefined, revert = false) {
    return lodash.reduce(
      obj,
      (p, v, k) => {
        if (key) {
          let p1 = k;
          let p2 = v[key];

          if (true === lowercase[0]) {
            p1 = "string" === typeof k ? k.toLowerCase() : k;
          }
          if (true === lowercase[1]) {
            p2 = "string" === typeof v[key] ? v[key].toLowerCase() : v[key];
          }

          if (true === revert) {
            if (undefined !== p2) {
              p[p2] = p1;
            }
          } else {
            if (undefined !== p1) {
              p[p1] = undefined === p2 ? defaultValue : p2;
            }
          }

          return p;
        }
      },
      {}
    );
  }

  function deepReduce(obj, key, lowercase = [false, false], defaultValue = undefined, revert = false) {
    return lodash.reduce(
      obj,
      (p, v, k) => {
        if (key) {
          (v[key] ? (Array.isArray(v[key]) ? v[key] : Object.entries(v[key] || {})) : []).forEach((c) => {
            function transToLowerCase(o) {
              if ("string" === typeof o) {
                return o.toLowerCase();
              } else if (Array.isArray(o)) {
                return lodash.transform(o, (r, c) =>
                  r.push(
                    Array.isArray(c)
                      ? c.map((e) => ("string" === typeof e ? e.toLowerCase() : e))
                      : "string" === typeof c
                      ? c.toLowerCase()
                      : c
                  )
                );
              } else {
                return lodash.transform(o, (r, v, k) => {
                  r["string" === typeof k ? k.toLowerCase() : k] = "string" === typeof v ? v.toLowerCase() : v;
                });
              }
            }

            let p1 = true === lowercase[0] ? transToLowerCase(k) : k;
            let p2 = true === lowercase[1] ? transToLowerCase(c) : c;

            if (true === revert) {
              if (undefined !== p2) {
                (undefined === p[p2] ? (p[p2] = []) : p[p2]).push(p1);
              }
            } else {
              if (undefined !== p1) {
                (undefined === p[p1] ? (p[p1] = []) : p[p1]).push(undefined === p2 ? defaultValue : p2);
              }
            }
          });
          return p;
        }
      },
      {}
    );
  }

  function add(key, name, prop, callback, ...rest) {
    global[key].functions[prop] = Object.assign(
      global[key].functions[prop] || {},
      callback(obj[name].functions, prop, ...rest)
    );
  }

  if (!["command", "master"].includes(type)) {
    return;
  }

  global[type].enable = reduce(obj, "enable", [true, false], false);
  global[type].weights = reduce(obj, "weights", [true, false], 0);
  global[type].regex = deepReduce(obj, "regex", [true, false], undefined, true);
  global[type].function = deepReduce(obj, "functions", [true, true]);
  global[type].functions = {};

  for (const name of Object.keys(obj)) {
    add(type, name, "type", reduce, [true, false], 0);
    add(type, name, "show", reduce, [true, false], true);
    add(type, name, "weights", reduce, [true, false], 0);
    add(type, name, "name", reduce, [true, false]);
    add(type, name, "usage", reduce, [true, false]);
    add(type, name, "revert", reduce, [true, false], false);
    add(type, name, "description", reduce, [true, false]);
    add(type, name, "entrance", deepReduce, [true, true]);
    add(type, name, "options", deepReduce, [true, true]);
  }

  global[type].function = lodash.reduce(
    global[type].function,
    (p, v, k) => {
      v.forEach((c) => (p[k] || (p[k] = [])).push(c[0]));
      return p;
    },
    {}
  );

  // ÊâÄÊúâ switch ËΩ¨Êç¢‰∏∫ option
  if (global[type].functions.type) {
    Object.keys(global[type].functions.type).forEach((f) => {
      if ("switch" === global[type].functions.type[f]) {
        global[type].functions.type[f] = "option";
        global[type].functions.options[f] = lodash
          .chain({})
          .assign({ on: "on" }, { off: "off" }, global[type].functions.options[f] || {})
          .pick(["on", "off"])
          .toPairs()
          .value();
      }
    });
  }

  global[type].functions.options = lodash.reduce(
    global[type].functions.options,
    (p, v, k) => {
      v.forEach((c) => {
        const value = undefined === c[1].toString ? c[1] : c[1].toString();
        const opName = c[0];
        const opValue = "string" === typeof value ? value.toLowerCase() : value;
        Object.assign(p[k] || (p[k] = {}), { [opName]: opValue });
      });
      return p;
    },
    {}
  );
}

// obj: global.command or global.master
function makeUsage(obj) {
  if (!(obj === global.command || obj === global.master)) {
    return "";
  }

  const listMark = "üîò";
  const commentMark = "üëâ";
  const pluginList = new Map(Object.entries(obj.weights).sort((a, b) => b[1] - a[1]));
  let text = "";

  for (const plugin of pluginList.keys()) {
    let functionWeights = {};

    if (!obj.enable[plugin]) {
      continue;
    }

    for (const k in obj.functions.weights) {
      if (obj.function[plugin].includes(k)) {
        functionWeights[k] = obj.functions.weights[k];
      }
    }

    const functionList = new Map(Object.entries(functionWeights).sort((a, b) => b[1] - a[1]));

    for (const func of functionList.keys()) {
      if (true === obj.functions.show[func] && obj.functions.name[func]) {
        const type = obj.functions.type[func] || "command";
        const optionsText = obj.functions.options[func]
          ? lodash.flatten(Object.values(obj.functions.options[func])).join("„ÄÅ")
          : "";

        text += `${listMark} `;

        if ("option" === type && true === obj.functions.revert[func]) {
          text += optionsText;
        }

        text += `${obj.functions.name[func]} `;

        if (null !== obj.functions.usage[func]) {
          text += `${obj.functions.usage[func]} `;
        }

        if ("option" === type && true !== obj.functions.revert[func]) {
          text += `<${optionsText}> `;
        }

        if (null !== obj.functions.description[func]) {
          text += `${commentMark} `;
        }

        text += `${obj.functions.description[func] || ""}\n`;
      }
    }
  }

  text += text ? `${"-".repeat(20)}\n<> Ë°®Á§∫ÂøÖÂ°´Ôºå[] Ë°®Á§∫ÂèØÈÄâ` : "Êàë‰ªÄ‰πàÈÉΩ‰∏ç‰ºöÂì¶„ÄÇ";

  obj.usage = text;
}

// global.authority.default     ->  authority: isOn (boolean)
// global.authority.setting     ->  authority: array of function (string)
// global.authority.function    ->  function: authority (string)
function readAuthority() {
  // Ê≠§‰∏∫ÈÖçÁΩÆÊñá‰ª∂‰∏≠Ê≤°ÊúâÂØπÂ∫îÂ≠óÊÆµÊàñËÄÖÁî®Êà∑ÈÖçÁΩÆ‰∫ÜÊó†ÊïàÁöÑÂÄºÊó∂ÔºåÂØπÂ∫îÂ≠óÊÆµÁöÑÈªòËÆ§ÂÄº
  const defaultConfig = {
    // Âú£ÈÅóÁâ©ÊùÉÈôê
    artifact_auth: "off",
    // Ê∏∏ÊàèÊï∞ÊçÆÊùÉÈôê
    character_overview_auth: "off",
    // Â∏¶ËØùÊùÉÈôê
    feedback_auth: "off",
    // Â®±‰πêÂäüËÉΩÊùÉÈôê
    fun_auth: "off",
    // ÊäΩÂç°ÊùÉÈôê
    gacha_auth: "off",
    // ÁÇπÊ≠åÊùÉÈôê
    music_auth: "off",
    // ËØÑÂàÜÊùÉÈôê
    rating_auth: "off",
    // Á±≥Ê∏∏Á§æÊñ∞ÈóªÊé®ÈÄÅ
    mys_news_auth: "off",
    // ÈóÆÁ≠îÊùÉÈôê
    qa_auth: "off",
    // Ê∂àÊÅØÂìçÂ∫î
    reply_auth: "off",
  };
  const defaultAuth = { ...defaultConfig, ...(m_AUTHORITY.default || {}) };

  // ËΩ¨Êç¢‰∏∫ boolean
  Object.keys(defaultAuth).forEach((k) => {
    if (!["on", "off"].includes(defaultAuth[k])) {
      defaultAuth[k] = defaultConfig[k] || "off";
    }

    defaultAuth[k] = "on" === defaultAuth[k];
  });

  global.authority.default = defaultAuth;
  global.authority.function = {};

  Object.keys(global.authority.setting).forEach((k) =>
    global.authority.setting[k].forEach((f) => (global.authority.function[f] = k))
  );
}

// global.config
function readSetting() {
  // Ê≠§‰∏∫ÈÖçÁΩÆÊñá‰ª∂‰∏≠Ê≤°ÊúâÂØπÂ∫îÂ≠óÊÆµÊàñËÄÖÁî®Êà∑ÈÖçÁΩÆ‰∫ÜÊó†ÊïàÁöÑÂÄºÊó∂ÔºåÂØπÂ∫îÂ≠óÊÆµÁöÑÈªòËÆ§ÂÄº
  const defaultConfig = {
    // ÁôªÂΩïÂçèËÆÆ‰∏∫ iPad
    platform: 5,
    // ‰∏çÂÖÅËÆ∏ @ Êú∫Âô®‰∫∫
    atMe: 0,
    // Áæ§ËÅäÂõûÂ§çÊó∂‰∏ç @ Áî®Êà∑
    atUser: 0,
    // ‰∏çÊ£ÄÊü•ÁÆ°ÁêÜÂëòÁöÑÊùÉÈôê
    checkMasterAuth: 0,
    // ‰∏çÂõûÂ§çÈôåÁîü‰∫∫Ê∂àÊÅØ
    replyStranger: 0,
    // ‰∏çÂ§çËØªÁæ§Ê∂àÊÅØ
    repeatProb: 0,
    // ‰∏çÂèëÈÄÅÁæ§ÈÄöÁü•
    groupHello: 0,
    // ‰∏çÂêëÊñ∞Áæ§ÂëòÈóÆÂ•Ω
    groupGreetingNew: 0,
    // ‰∏çÂêëÊñ∞Â•ΩÂèãÈóÆÂ•Ω
    friendGreetingNew: 0,
    // ‰∏çÊé®ÈÄÅÁ±≥Ê∏∏Á§æÊñ∞Èóª
    noticeMysNews: 0,
    // Êé®ÈÄÅ‰∏çÈôêÊó∂Èó¥ÁöÑÁ±≥Ê∏∏Á§æÊñ∞Èóª
    noticeMysNewsWithinHours: 0,
    // Êó†Á±≥Ê∏∏Á§æÊñ∞ÈóªÊé®ÈÄÅÁ±ªÂûã
    mysNewsType: [],
    // ËßíËâ≤Êü•ËØ¢‰∏çÂ∞ùËØïÊãâÂèñÊï∞ÊçÆ
    characterTryGetDetail: 0,
    // ËÄóÊó∂Êìç‰ΩúÂâç‰∏çÂèëÈÄÅÊèêÁ§∫
    warnTimeCosts: 0,
    // ‰∏çÂØπÁî®Êà∑ÁöÑ‰ΩøÁî®È¢ëÁéá‰ΩúÂá∫ÈôêÂà∂
    requestInterval: 0,
    // ‰∏çÂ∞ùËØïÊí§ÂõûÂèëÈÄÅÁöÑÁæ§Ê∂àÊÅØ
    deleteGroupMsgTime: 0,
    // ÂπøÊí≠‰∏≠Ê∂àÊÅØÈó¥Êó∂Âª∂ 0.1 Áßí
    boardcastDelay: 0.1,
    // Ê∑±Ê∏äËÆ∞ÂΩïÁºìÂ≠ò‰∏ÄÂ∞èÊó∂
    cacheAbyEffectTime: 1,
    // Áé©ÂÆ∂Êï∞ÊçÆÁºìÂ≠ò‰∏ÄÂ∞èÊó∂
    cacheInfoEffectTime: 1,
    // Êï∞ÊçÆÂ∫ì aby ÁöÑÊï∞ÊçÆÊúâÊïàÊÄß‰∏∫‰∏ÄÂ∞èÊó∂
    dbAbyEffectTime: 1,
    // Êï∞ÊçÆÂ∫ì info ÁöÑÊï∞ÊçÆÊúâÊïàÊÄß‰∏∫‰∏ÄÊòüÊúü
    dbInfoEffectTime: 168,
    // ‰∏ç‰ΩøÁî®ÂâçÁ´ØË∞ÉËØïÊ®°Âºè
    viewDebug: 0,
    // ‰∏ç‰øùÂ≠òÂõæÁâá
    saveImage: 0,
  };

  // Áî®‰∫éÂÖºÂÆπÊóßÈÖçÁΩÆÔºåÂ∑≤ÁªèË¢´ accounts Âèñ‰ª£
  const account = m_SETTING.account;
  const accounts = m_SETTING.accounts;
  // Áî®‰∫éÂÖºÂÆπÊóßÈÖçÁΩÆÔºåÂ∑≤ÁªèË¢´ masters Âèñ‰ª£
  const master = m_SETTING.master;
  const masters = m_SETTING.masters;
  const prefixes = m_SETTING.prefixes;
  const atMe = parseInt(m_SETTING.atMe);
  const atUser = parseInt(m_SETTING.atUser);
  const checkMasterAuth = parseInt(m_SETTING.checkMasterAuth);
  const replyStranger = parseInt(m_SETTING.replyStranger);
  const repeatProb = parseInt(parseFloat(m_SETTING.repeatProb) * 100);
  const groupHello = parseInt(m_SETTING.groupHello);
  const groupGreetingNew = parseInt(m_SETTING.groupGreetingNew);
  const friendGreetingNew = parseInt(m_SETTING.friendGreetingNew);
  const noticeMysNews = parseInt(m_SETTING.noticeMysNews);
  const noticeMysNewsWithinHours = parseInt(m_SETTING.noticeMysNewsWithinHours);
  const mysNewsType = Array.isArray(m_SETTING.mysNewsType) ? m_SETTING.mysNewsType : [];
  const characterTryGetDetail = parseInt(m_SETTING.characterTryGetDetail);
  const warnTimeCosts = parseInt(m_SETTING.warnTimeCosts);
  const requestInterval = parseInt(m_SETTING.requestInterval);
  const deleteGroupMsgTime = parseInt(m_SETTING.deleteGroupMsgTime);
  const boardcastDelay = parseInt(parseFloat(m_SETTING.boardcastDelay) * 1000);
  const cacheAbyEffectTime = parseInt(m_SETTING.cacheAbyEffectTime);
  const cacheInfoEffectTime = parseInt(m_SETTING.cacheInfoEffectTime);
  const dbAbyEffectTime = parseInt(m_SETTING.dbAbyEffectTime);
  const dbInfoEffectTime = parseInt(m_SETTING.dbInfoEffectTime);
  const viewDebug = parseInt(m_SETTING.viewDebug);
  const saveImage = parseInt(m_SETTING.saveImage);

  (function getConfig(...items) {
    items.forEach((o) => {
      const prop = Object.keys(o)[0];
      const val = o[prop];

      global.config[prop] = val;

      // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Equality_comparisons_and_sameness
      if ([undefined, null, NaN, ""].includes(val)) {
        global.config[prop] = defaultConfig[prop];
      }
    });
  })(
    { accounts: [...(accounts || []), ...(account ? [account] : [])] },
    { masters: [...(masters || []), ...(master ? [master] : [])] },
    {
      prefixes: Array.isArray(prefixes) ? prefixes : prefixes ? [prefixes] : [],
    },
    { atMe },
    { atUser },
    { checkMasterAuth },
    { replyStranger },
    { repeatProb },
    { groupHello },
    { groupGreetingNew },
    { friendGreetingNew },
    { noticeMysNews },
    { noticeMysNewsWithinHours },
    { mysNewsType },
    { characterTryGetDetail },
    { warnTimeCosts },
    { requestInterval },
    { deleteGroupMsgTime },
    { boardcastDelay },
    { cacheAbyEffectTime },
    { cacheInfoEffectTime },
    { dbAbyEffectTime },
    { dbInfoEffectTime },
    { viewDebug },
    { saveImage }
  );

  // ‰ª•‰∏ãÈÄâÈ°π‰∏ç‰∏∫Ë¥üÊï∞
  global.config.repeatProb = Math.max(global.config.repeatProb, 0);
  global.config.requestInterval = Math.max(global.config.requestInterval, 0);
  global.config.deleteGroupMsgTime = Math.max(global.config.deleteGroupMsgTime, 0);
  global.config.boardcastDelay = Math.max(global.config.boardcastDelay, 0);
  global.config.cacheAbyEffectTime = Math.max(global.config.cacheAbyEffectTime, 0);
  global.config.cacheInfoEffectTime = Math.max(global.config.cacheInfoEffectTime, 0);
  global.config.dbAbyEffectTime = Math.max(global.config.dbAbyEffectTime, 0);
  global.config.dbInfoEffectTime = Math.max(global.config.dbInfoEffectTime, 0);

  // ËÆæÁΩÆÊØè‰∏™ QQ Ë¥¶Êà∑ÁöÑÁôªÂΩïÈÄâÈ°πÈªòËÆ§ÂÄº
  for (const option of global.config.accounts) {
    // ÂØÜÁ†ÅËΩ¨Êç¢‰∏∫ string
    if (null !== option.password) {
      option.password = option.password.toString();
    }

    // 1:ÂÆâÂçìÊâãÊú∫„ÄÅ 2:aPad „ÄÅ 3:ÂÆâÂçìÊâãË°®„ÄÅ 4:MacOS „ÄÅ 5:iPad
    if (![1, 2, 3, 4, 5].includes(option.platform)) {
      option.platform = defaultConfig.platform;
    }
  }

  // ËΩ¨ÂåñÊØè‰∏™‰∏ç‰∏∫ null ÁöÑÂëΩ‰ª§ÂâçÁºÄÁöÑÊï∞ÊçÆÁ±ªÂûã‰∏∫ string
  for (const i in global.config.prefixes) {
    if (global.config.prefixes[i]) {
      global.config.prefixes[i] = global.config.prefixes[i].toString();
    }
  }

  // ËÆæÁΩÆÈÄâÈ°π atMe ÁöÑÈªòËÆ§ÂÄº
  if (![0, 1, 2].includes(global.config.atMe)) {
    global.config.atMe = defaultConfig.atMe;
  }

  // ËøáÊª§ÂêàÊ≥ïÁöÑÁ±≥Ê∏∏Á§æÊñ∞ÈóªÊé®ÈÄÅ
  global.config.mysNewsType = global.config.mysNewsType.filter((c) =>
    global.config.mysNewsTypeAll.includes(c.toLowerCase())
  );
}

// global.cookies:              ->  array of cookie (string)
function readCookies() {
  if (lodash.hasIn(m_COOKIES, "cookies")) {
    switch (true) {
      case Array.isArray(m_COOKIES.cookies):
        global.cookies = m_COOKIES.cookies;
        break;
      case "string" === typeof m_COOKIES.cookies:
        global.cookies = [m_COOKIES.cookies];
        break;
    }
  }

  global.cookies = global.cookies.filter((e, i) => global.cookies.indexOf(e) === i);
}

function readGreeting() {
  global.greeting = Object.assign(
    {
      online: "Êàë‰∏äÁ∫ø‰∫Ü„ÄÇ",
      offline: "Êàë‰∏ãÁ∫ø‰∫Ü„ÄÇ",
      die: "Êàë‰∏äÁ∫ø‰∫Ü„ÄÇ",
      hello: "Â§ßÂÆ∂Â•Ω„ÄÇ",
      new: "‰Ω†Â•Ω„ÄÇ",
    },
    m_GREETING
  );
}

function readMenu() {
  function parse(o) {
    Object.keys(o).forEach((k) => (o[k] = Array.isArray(o[k]) ? o[k] : o[k] ? [o[k]] : []));
  }

  global.menu = {};
  global.menu.eat = m_MENU.eat || {};
  global.menu.drink = m_MENU.drink || {};

  parse(global.menu.eat);
  parse(global.menu.drink);
}

function readProphecy() {
  global.prophecy = { ...m_PROPHECY };
  global.prophecy.data = Array.isArray(global.prophecy.data) ? global.prophecy.data : [];
}

// global.names.character       ->  array of character (string, lowercase)
// global.names.weapon          ->  array of weapon (string, lowercase)
// global.names.all             ->  array of name (string, lowercase)
// global.names.characterAlias  ->  name (lowercase): alias (string, lowercase)
// global.names.weaponAlias     ->  name (lowercase): alias (string, lowercase)
// global.names.allAlias        ->  name (lowercase): alias (string, lowercase)
function readNames() {
  function getSection(s) {
    function getExtra(o) {
      return lodash.merge(...o.map((c) => ({ [c.name]: [] })));
    }

    return lodash.reduce(
      { ...getExtra(global.info[s]), ...(m_NAMES[s] || {}) },
      (p, v, k) => {
        (v || (v = [])).push(k);
        v.forEach((c) => (p["string" === typeof c ? c.toLowerCase() : c] = k));
        return p;
      },
      {}
    );
  }

  function getNames(o) {
    return lodash.chain(o).toPairs().flatten().uniq().value();
  }

  global.names.characterAlias = getSection("character");
  global.names.weaponAlias = getSection("weapon");
  global.names.allAlias = { ...global.names.characterAlias, ...global.names.weaponAlias };
  global.names.character = getNames(global.names.characterAlias);
  global.names.weapon = getNames(global.names.weaponAlias);
  global.names.all = getNames(global.names.allAlias);
}

// global.artifacts.weights          -> weights (array of array of number)
// global.artifacts.values           -> values (array of array of number)
// global.artifacts.props            -> props (array of object)
// global.artifacts.artifacts.id     -> suit (lowercase):  id (number)
// global.artifacts.artifacts.rarity -> id:                rarity (number)
// global.artifacts.artifacts.icon   -> icon:              id (number)
// global.artifacts.artifacts.suit   -> id:                suit (string, lowercase)
// global.artifacts.artifacts.names  -> id:                names (array of string, lowercase)
// global.artifacts.domains.id       -> name (lowercase):  id (number)
// global.artifacts.domains.name     -> id:                name (string, lowercase)
// global.artifacts.domains.alias    -> alias (lowercase): name (string, lowercase)
// global.artifacts.domains.aliasOf  -> id:                alias (array of string, lowercase)
// global.artifacts.domains.product  -> id:                product (array of number)
function readArtifacts() {
  function reduce(prop, key = [undefined, undefined], lowercase = [false, false]) {
    if (!key.includes(undefined)) {
      return lodash.reduce(
        m_ARTIFACTS[prop] || [],
        (p, v) => {
          let p1 = v[key[0]];
          let p2 = v[key[1]];

          if (true === lowercase[0]) {
            p1 = "string" === typeof p1 ? p1.toLowerCase() : p1;
          }
          if (true === lowercase[1]) {
            p2 = "string" === typeof p2 ? p2.toLowerCase() : Array.isArray(p2) ? p2.map((c) => c.toLowerCase()) : p2;
          }

          p[p1] = p2;
          return p;
        },
        {}
      );
    }
  }

  function deepReduce(prop, key = [undefined, undefined], lowercase = [false, false]) {
    if (!key.includes(undefined)) {
      return lodash.reduce(
        m_ARTIFACTS[prop] || [],
        (p, v) => {
          (v[key[0]] || []).forEach((c) => {
            (Array.isArray(c) ? c : [c]).forEach((c) => {
              let p1 = c;
              let p2 = v[key[1]];

              if (true === lowercase[0]) {
                p1 = "string" === typeof p1 ? p1.toLowerCase() : p1;
              }
              if (true === lowercase[1]) {
                p2 =
                  "string" === typeof p2 ? p2.toLowerCase() : Array.isArray(p2) ? p2.map((c) => c.toLowerCase()) : p2;
              }

              p[p1] = p2;
            });
          });
          return p;
        },
        {}
      );
    }
  }

  global.artifacts.weights = m_ARTIFACTS.weights;
  global.artifacts.values = m_ARTIFACTS.values;
  global.artifacts.props = m_ARTIFACTS.props;
  global.artifacts.path = m_ARTIFACTS.path;
  global.artifacts.artifacts = {};
  global.artifacts.artifacts.id = reduce("artifacts", ["suit", "id"], [true, false]);
  global.artifacts.artifacts.rarity = reduce("artifacts", ["id", "rarity"], [false, false]);
  global.artifacts.artifacts.icon = reduce("artifacts", ["icon", "id"], [false, false]);
  global.artifacts.artifacts.suit = reduce("artifacts", ["id", "suit"], [false, true]);
  global.artifacts.artifacts.names = reduce("artifacts", ["id", "names"], [false, true]);
  global.artifacts.domains = {};
  global.artifacts.domains.id = reduce("domains", ["name", "id"], [true, false]);
  global.artifacts.domains.name = reduce("domains", ["id", "name"], [false, true]);
  global.artifacts.domains.alias = deepReduce("domains", ["alias", "name"], [true, true]);
  global.artifacts.domains.aliasOf = reduce("domains", ["id", "alias"], [false, true]);
  global.artifacts.domains.product = reduce("domains", ["id", "product"], [false, false]);
}

// Call after readNames()
//
// global.info.character    -> array of { access, ascensionMaterials, baseATK, birthday, constellationName,
//                                        constellations, cvCN, cvJP, element, id, introduce, levelUpMaterials,
//                                        mainStat, mainValue, name, passiveDesc, passiveTitle, rarity,
//                                        talentMaterials, time, title, type }, sorted by rarity
// global.info.weapon       -> array of { access, ascensionMaterials, baseATK, introduce, mainStat, mainValue, name,
//                                        rarity, skillContent, skillName, time, title, type }, sorted by rarity
function readInfo() {
  const dir = path.resolve(global.rootdir, "resources", "info", "doc");
  const info = ls(dir)
    .filter((c) => {
      const p = path.parse(c);
      return ".json" === p.ext;
    })
    .map((c) => {
      const p = path.parse(c);
      return JSON.parse(fs.readFileSync(path.resolve(p.dir, p.base))) || {};
    });

  global.info = {};
  global.info.character = lodash
    .chain(info)
    .filter((c) => "ËßíËâ≤" === c.type)
    .sortBy("rarity")
    .reverse()
    .forEach((c) => {
      if (Array.isArray(c.constellations) && 4 === c.constellations.length) {
        [2, 4].forEach((i) => c.constellations.splice(i, 0, ""));
      }
    })
    .value();
  global.info.weapon = lodash
    .chain(info)
    .filter((c) => "Ê≠¶Âô®" === c.type)
    .sortBy("rarity")
    .reverse()
    .value();
}

// Call after readInfo()
//
// global.eggs.type: name -> type (string)
// global.eggs.star: name -> type (string)
function readEggs() {
  global.eggs.type = {};
  global.eggs.star = {};

  ((m_EGGS || {}).items || []).forEach((c) => {
    if (Array.isArray(c.names) && "string" === typeof c.type) {
      c.names.forEach((n) => {
        if ("string" === typeof n) {
          global.eggs.type[n] = c.type;
          global.eggs.star[n] = parseInt(c.rarity) || 5;
        }
      });
    }
  });

  if (0 === Object.keys(global.eggs.type).length || 0 === Object.keys(global.eggs.star).length) {
    global.eggs.type = {};
    global.eggs.star = {};

    [...global.info.character, ...global.info.weapon].forEach((c) => {
      // Âè™Ë¶Å‰∫îÊòü
      if ("string" === typeof c.type && 5 === parseInt(c.rarity) && "Á•àÊÑø" === c.access) {
        global.eggs.type[c.name] = c.type;
        global.eggs.star[c.name] = 5;
      }
    });
  }
}

// global.qa:   regex -> settings (object)
function readQa() {
  if (Array.isArray(m_QA?.settings)) {
    Object.assign(
      global.qa,
      lodash
        .chain(m_QA.settings)
        .filter(
          (c) =>
            Array.isArray(c?.match) &&
            c?.match?.length > 0 &&
            "string" === typeof c?.reply &&
            "" !== c?.reply &&
            ["text", "image", "executable", "command"].includes(c?.type)
        )
        .map((c) => Object.assign(c, { ignoreCase: !!c.ignoreCase, master: !!c.master }))
        .reduce((p, v) => {
          v.match.forEach((c) => (p[c] = lodash.omit(v, "match")));
          return p;
        }, {})
        .value()
    );
  }
}

// global.material.MonThu   -> array of name (string, lowercase)
// global.material.TueFri   -> array of name (string, lowercase)
// global.material.WedSat   -> array of name (string, lowercase)
function readMaterial() {
  const keyFromZhou = {
    Âë®‰∏Ä: ["MonThu"],
    Âë®‰∫å: ["TueFri"],
    Âë®‰∏â: ["WedSat"],
    ÊóÖË°åËÄÖÊØèÊó•Âç†‰ΩçÁ¨¶: ["MonThu", "TueFri", "WedSat"],
  };

  global.material = {};

  lodash
    .chain(keyFromZhou)
    .values()
    .concat()
    .flatten()
    .uniq()
    .each((k) => (global.material[k] = []))
    .value();

  [...global.info.character, ...global.info.weapon].forEach((c) =>
    Object.keys(keyFromZhou).forEach((zhou) => {
      if (undefined !== c.time && "string" === typeof c.time && c.time.includes(zhou)) {
        keyFromZhou[zhou].forEach((k) => global.material[k].push(c.name.toString().toLowerCase()));
      }
    })
  );
}

// global.command
// global.master
function readCommand() {
  getCommand(m_COMMAND, "command");
  getCommand(m_MASTER, "master");
}

// global.all.function
// global.all.functions.options
// global.all.functions.entrance
// global.all.functions.revert
// global.all.functions.type
function getAll() {
  function merge(o, p, o1, o2) {
    o[p] = {};
    // ËøôÈáåÂèØËÉΩÊúâÈáçÂ§çÁöÑ key ÈúÄË¶ÅÊâãÂä®Â§ÑÁêÜ‰∏Ä‰∏ã
    for (const k of [...new Set([...Object.keys(o1 || {}), ...Object.keys(o2 || {})])]) {
      o[p][k] = [...new Set([...((o1 || {})[k] || []), ...((o2 || {})[k] || [])])];
    }
  }

  global.all.functions = {};
  global.all.functions.options = { ...global.command.functions.options, ...global.master.functions.options };
  global.all.functions.revert = { ...global.command.functions.revert, ...global.master.functions.revert };
  global.all.functions.type = { ...global.command.functions.type, ...global.master.functions.type };
  merge(global.all, "function", global.command.function, global.master.function);
  merge(global.all.functions, "entrance", global.command.functions.entrance, global.master.functions.entrance);
}

// global.command.usage
// global.master.usage
function getUsage() {
  makeUsage(global.command);
  makeUsage(global.master);
}

function readConfig() {
  // ‰∏çË¶ÅÊîπÂèòË∞ÉÁî®È°∫Â∫è
  readAuthority();
  readSetting();
  readCookies();
  readGreeting();
  readMenu();
  readProphecy();
  readArtifacts();
  readInfo();
  readNames();
  readEggs();
  readQa();
  readMaterial();
  readCommand();
  getAll();
  getUsage();
}

function hasEntrance(message, plugin, ...entrance) {
  const messageu = message.toLowerCase(); // ÂøΩÁï•Â§ßÂ∞èÂÜô

  if (undefined === global.all.function[plugin]) {
    return false;
  }

  for (const e of entrance) {
    // È™åËØÅ entrance ÊòØÂê¶Âú®Êèí‰ª∂‰∏≠
    if (!global.all.function[plugin].includes(e)) {
      continue;
    }

    if (!Array.isArray(global.all.functions.entrance[e])) {
      continue;
    }

    // È™åËØÅ message ÊòØÂê¶‰ª• entrance ÂØπÂ∫îÁöÑÂ≠óÁ¨¶‰∏≤ÂºÄÂßã
    for (const t of global.all.functions.entrance[e]) {
      if ("string" === typeof t && new RegExp(t, "i").test(messageu)) {
        return true;
      }
    }
  }

  return false;
}

export { hasEntrance, readConfig };
